<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุฏูุฑ ููุงูุน ุงููุดุงุฑูุน ุงูุฌุบุฑุงูู</title>
    <!-- ุชุญููู Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ุชุญููู Lucide Icons (ูุฃููููุงุช ุงููุดุฑูุน) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* ุชุนุฑูู ุฎุท Inter ูุถูุงู ูุฑุงุกุฉ ุฌูุฏุฉ ููุฃุฑูุงู ูุงูุญุฑูู ุงููุงุชูููุฉ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        
        /* ุชุฎุตูุต ูุคุดุฑ Range Input */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            box-shadow: 0 0 2px 0 #3b82f6;
        }

        /* ูุถุจุท ุนุฑุถ ุงูุฃููููุงุช ุจุนุฏ ุชุญููููุง ุจูุงุณุทุฉ Lucide */
        .lucide-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .lucide-icon > svg {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">

    <!-- ุญุงููุฉ ุงูุชุทุจูู ุงูุฑุฆูุณูุฉ -->
    <div id="app-container" class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-xl p-6 mb-6 transform transition duration-300 hover:shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <span id="map-pin-header" class="lucide-icon w-8 h-8 text-indigo-600"></span>
                    <h1 class="text-3xl font-extrabold text-gray-900">ูุฏูุฑ ููุงูุน ุงููุดุงุฑูุน</h1>
                </div>
                <button
                    id="copy-all-btn"
                    class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-150 transform hover:scale-[1.02]"
                >
                    <span id="download-icon" class="lucide-icon w-5 h-5"></span>
                    ูุณุฎ ุงููู ููุดูุช
                </button>
            </div>
            <p class="text-gray-600">ุฃุฏุงุฉ ุฐููุฉ ูุฅุถุงูุฉ ูุฅุฏุงุฑุฉ ููุงูุน ุงููุดุงุฑูุน ุงูุฌุบุฑุงููุฉ ูุน ุงูุชุญูู ูู ุงูุชุฏุงุฎู</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- ุฅุถุงูุฉ ูุดุฑูุน ุฌุฏูุฏ -->
            <div class="bg-white rounded-xl shadow-xl p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span id="plus-icon-add" class="lucide-icon w-6 h-6 text-indigo-600"></span>
                    ุฅุถุงูุฉ ูุดุฑูุน ุฌุฏูุฏ
                </h2>

                <form id="new-project-form" class="space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-2">ุงุณู ุงููุดุฑูุน</label>
                        <input
                            type="text" id="name" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition duration-150"
                            placeholder="ูุซุงู: ุงููุณูุนุ ุฑุณูู 15"
                        />
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="lat" class="block text-sm font-medium text-gray-700 mb-2">ุฎุท ุงูุนุฑุถ (Latitude)</label>
                            <input
                                type="text" id="lat" required pattern="[-+]?\d*\.?\d+"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 font-mono text-sm transition duration-150"
                                placeholder="24.7819959"
                            />
                        </div>
                        <div>
                            <label for="lon" class="block text-sm font-medium text-gray-700 mb-2">ุฎุท ุงูุทูู (Longitude)</label>
                            <input
                                type="text" id="lon" required pattern="[-+]?\d*\.?\d+"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 font-mono text-sm transition duration-150"
                                placeholder="46.6174248"
                            />
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ูุทุงู ุงูุญุถูุฑ (ูุชุฑ): <span id="radius-display" class="font-bold text-indigo-600">500</span>ู
                        </label>
                        <input
                            type="range" id="radius" min="100" max="2000" step="100" value="500"
                            class="w-full h-2 bg-indigo-100 rounded-lg appearance-none cursor-pointer"
                        />
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>100ู</span>
                            <span>2000ู</span>
                        </div>
                    </div>

                    <button
                        type="button" id="import-url-btn"
                        class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition duration-150 transform hover:scale-[1.01]"
                    >
                        <span id="upload-icon" class="lucide-icon w-5 h-5"></span>
                        ุงุณุชูุฑุงุฏ ูู ุฑุงุจุท Google Maps
                    </button>

                    <!-- ุชูุจููุงุช ุงูุชุฏุงุฎู -->
                    <div id="warnings-container" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <!-- Warnings content will be rendered here -->
                    </div>

                    <button
                        type="submit"
                        class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-indigo-600 text-white rounded-lg shadow-lg hover:bg-indigo-700 transition duration-150 font-medium transform hover:scale-[1.01]"
                    >
                        <span id="plus-icon-submit" class="lucide-icon w-5 h-5"></span>
                        ุฅุถุงูุฉ ุงููุดุฑูุน
                    </button>
                </form>
            </div>

            <!-- ุงูุฎุฑูุทุฉ ุงูุชูุงุนููุฉ -->
            <div class="bg-white rounded-xl shadow-xl p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span id="map-pin-map" class="lucide-icon w-6 h-6 text-indigo-600"></span>
                    ุงูุฎุฑูุทุฉ ุงูุชูุงุนููุฉ (ููุชุญุฏูุฏ ุงูุชูุฑูุจู)
                </h2>
                <div
                    id="map-simulation"
                    class="w-full h-96 bg-gradient-to-br from-green-100 to-blue-100 rounded-lg relative cursor-crosshair border-2 border-gray-300 overflow-hidden"
                >
                    <div class="absolute top-2 right-2 bg-white px-3 py-1 rounded-lg shadow text-xs text-gray-600 z-10">
                        ุงุถุบุท ุนูู ุงูุฎุฑูุทุฉ ูุชุญุฏูุฏ ุงููููุน
                    </div>
                    <!-- Projects and selected location will be rendered here -->
                </div>
                <p class="text-sm text-gray-600 mt-3">
                    ๐ก ูุตูุญุฉ: ุงุณุชุฎุฏู ุฒุฑ "ุงุณุชูุฑุงุฏ ูู ุฑุงุจุท Google Maps" ููุญุตูู ุนูู ุฅุญุฏุงุซูุงุช ุฏูููุฉ
                </p>
            </div>
        </div>

        <!-- ูุงุฆูุฉ ุงููุดุงุฑูุน -->
        <div class="bg-white rounded-xl shadow-xl p-6 mt-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">ุงููุดุงุฑูุน ุงููุถุงูุฉ (<span id="projects-count">0</span>)</h2>
                <div class="relative">
                    <span id="search-icon" class="lucide-icon absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></span>
                    <input
                        type="text" id="search-query"
                        class="pr-10 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition duration-150"
                        placeholder="ุจุญุซ..."
                    />
                </div>
            </div>

            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table class="w-full min-w-max">
                    <thead>
                        <tr class="bg-gray-50 border-b border-gray-200">
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">ุงุณู ุงููุดุฑูุน</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">ุฎุท ุงูุนุฑุถ</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">ุฎุท ุงูุทูู</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">ุงููุทุงู (ู)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="projects-table-body">
                        <!-- Projects data will be rendered here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ุชุนูููุงุช ุงูุงุณุชุฎุฏุงู -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-700 rounded-xl shadow-lg p-6 mt-6 text-white transform transition duration-300 hover:shadow-2xl hover:scale-[1.005]">
            <h3 class="text-xl font-bold mb-3 flex items-center gap-2">
                <span id="book-icon" class="lucide-icon w-5 h-5 text-yellow-300"></span>
                ููููุฉ ุงูุงุณุชุฎุฏุงู:
            </h3>
            <ol class="list-none space-y-2 text-sm">
                <li class="flex items-start gap-2">
                    <span class="font-bold text-lg text-yellow-300">1๏ธโฃ</span>
                    <span>ุงูุณุฎ ุฑุงุจุท Google Maps ูููุดุฑูุน ูุงุถุบุท "ุงุณุชูุฑุงุฏ ูู ุฑุงุจุท" ููููู ุงููุธุงู ุจุงุณุชุฎุฑุงุฌ ุงูุฅุญุฏุงุซูุงุช ุชููุงุฆููุง.</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="font-bold text-lg text-yellow-300">2๏ธโฃ</span>
                    <span>ุฃู ุงุถุบุท ุนูู ุงูุฎุฑูุทุฉ ุงูุชูุงุนููุฉ ูุชุญุฏูุฏ ุงููููุน ุงูุชูุฑูุจูุ ุฃู ุฃุฏุฎู ุงูุฅุญุฏุงุซูุงุช ูุฏููุงู.</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="font-bold text-lg text-yellow-300">3๏ธโฃ</span>
                    <span>ุญุฏุฏ ูุทุงู ุงูุญุถูุฑ ุงููุทููุจ (Radius) ุจุงุณุชุฎุฏุงู ุดุฑูุท ุงูุชูุฑูุฑ.</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="font-bold text-lg text-yellow-300">4๏ธโฃ</span>
                    <span>ุงุถุบุท "ุฅุถุงูุฉ ุงููุดุฑูุน" - ุณูููู ุงููุธุงู ุจุงูุชุญูู ูู ูุฌูุฏ ุฃู ุชุฏุงุฎู ูุน ุงููุดุงุฑูุน ุงูุฃุฎุฑู.</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="font-bold text-lg text-yellow-300">5๏ธโฃ</span>
                    <span>ุงุณุชุฎุฏู ุฒุฑ "ูุณุฎ" ููุณุฎ ุจูุงูุงุช ุตู ูุนููุ ุฃู "ูุณุฎ ุงููู ููุดูุช" ููุณุฎ ุฌููุน ุงูุจูุงูุงุช ููุทุจุงุนุฉ ูู Google Sheets.</span>
                </li>
            </ol>
        </div>
    </div>

    <!-- ูุฎุตุต: ูุงูุฐุฉ ุงูุชุฃููุฏ (ุจุฏูู ูู window.confirm) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 transition-opacity duration-300" aria-modal="true" role="dialog">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm mx-4 p-6 transform transition-all duration-300 scale-95" id="modal-content">
            <div class="flex flex-col items-center">
                <span id="alert-triangle-icon" class="lucide-icon w-12 h-12 text-yellow-500 mb-4"></span>
                <h3 class="text-xl font-bold text-gray-900 mb-2" id="modal-title">ุชุญุฐูุฑ ุชุฏุงุฎู ุงููููุน</h3>
                <p class="text-gray-600 text-center mb-6 text-sm" id="modal-message">
                    <!-- Message content will be inserted here -->
                </p>
                <div class="flex justify-center gap-4 w-full">
                    <button id="modal-cancel-btn" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">
                        ุฅูุบุงุก
                    </button>
                    <button id="modal-confirm-btn" class="flex-1 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition shadow-md">
                        ุงููุชุงุจุนุฉ ุฑุบู ุงูุชุญุฐูุฑ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ูุฎุตุต: ูุธุงู ุงูุชูุจููุงุช (ุจุฏูู ูู window.alert) -->
    <div id="toast-message" class="fixed top-4 right-1/2 translate-x-1/2 px-6 py-3 bg-gray-800 text-white rounded-xl shadow-2xl opacity-0 transition-opacity duration-300 z-50 pointer-events-none" role="alert">
        <!-- Message content will be inserted here -->
    </div>

    <script>
        // ุฏุงูุฉ ูุฅุธูุงุฑ ุงูุฃููููุงุช ูู Lucide
        function renderIcons() {
            lucide.createIcons({
                icons: {
                    MapPin: document.getElementById('map-pin-header'),
                    Download: document.getElementById('download-icon'),
                    Plus: [document.getElementById('plus-icon-add'), document.getElementById('plus-icon-submit')],
                    Upload: document.getElementById('upload-icon'),
                    AlertTriangle: document.getElementById('alert-triangle-icon'),
                    Search: document.getElementById('search-icon'),
                    Book: document.getElementById('book-icon')
                }
            });
        }
        
        // ====================================================================
        // 1. ุฅุฏุงุฑุฉ ุงูุญุงูุฉ (State Management)
        // ====================================================================
        const state = {
            projects: [],
            newProject: {
                name: '',
                lat: '',
                lon: '',
                radius: 500
            },
            searchQuery: '',
            selectedLocation: null,
            copiedIndex: null,
            warnings: [],
            modal: {
                isVisible: false,
                title: '',
                message: '',
                confirmAction: () => {}
            }
        };

        // ====================================================================
        // 2. ุฏูุงู ูุณุงุนุฏุฉ (Utilities)
        // ====================================================================

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ุจุณูุทุฉ ูู ูุงูุฐุฉ ุงูุชูุณุช (ุจุฏูู ูู alert)
        function showToast(message, duration = 2000) {
            const toast = document.getElementById('toast-message');
            toast.textContent = message;
            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100');

            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, duration);
        }

        // ุฅุธูุงุฑ ูุงูุฐุฉ ุงูุชุฃููุฏ (ุจุฏูู ูู confirm)
        function showConfirmationModal(title, message, confirmAction) {
            state.modal.title = title;
            state.modal.message = message;
            state.modal.confirmAction = confirmAction;
            
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message;
            const modal = document.getElementById('confirmation-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            // Apply scale-in effect
            setTimeout(() => {
                document.getElementById('modal-content').classList.remove('scale-95');
                document.getElementById('modal-content').classList.add('scale-100');
            }, 10);
        }

        function hideConfirmationModal() {
            const modalContent = document.getElementById('modal-content');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                document.getElementById('confirmation-modal').classList.remove('flex');
                document.getElementById('confirmation-modal').classList.add('hidden');
            }, 300); // Wait for transition
        }


        // ุญุณุงุจ ุงููุณุงูุฉ ุจูู ููุทุชูู (Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // ูุตู ูุทุฑ ุงูุฃุฑุถ ุจุงููุชุฑ
            const toRad = (deg) => deg * (Math.PI / 180);

            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);

            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // ุงูุชุญูู ูู ุงูุชุฏุงุฎู
        function checkOverlap(lat, lon, radius) {
            const overlaps = [];
            const newLat = parseFloat(lat);
            const newLon = parseFloat(lon);
            const newRadius = parseFloat(radius);

            if (isNaN(newLat) || isNaN(newLon) || isNaN(newRadius)) return [];

            state.projects.forEach(project => {
                const distance = calculateDistance(newLat, newLon, project.lat, project.lon);
                const combinedRadius = newRadius + project.radius;
                
                if (distance < combinedRadius) {
                    overlaps.push({
                        project: project.name,
                        distance: Math.round(distance),
                        message: `ุชุญุฐูุฑ: ุงููุดุฑูุน ูุฑูุจ ุฌุฏุงู ูู "${project.name}" - ุงููุณุงูุฉ ุจูู ุงููุฑุงูุฒ: ${Math.round(distance)}ู (ูุฌููุน ุงููุทุงููู: ${combinedRadius}ู)`
                    });
                }
            });
            return overlaps;
        }

        // ุชุญุฏูุซ ุงูุชุญุฐูุฑุงุช ูู ูุงุฌูุฉ ุงููุณุชุฎุฏู
        function updateWarnings() {
            const container = document.getElementById('warnings-container');
            const newLat = document.getElementById('lat').value;
            const newLon = document.getElementById('lon').value;
            const newRadius = document.getElementById('radius').value;

            if (!newLat || !newLon) {
                container.classList.add('hidden');
                state.warnings = [];
                return;
            }

            const overlaps = checkOverlap(newLat, newLon, newRadius);
            state.warnings = overlaps;

            if (overlaps.length > 0) {
                container.classList.remove('hidden');
                let html = `
                    <div class="flex items-start gap-2">
                        <span class="lucide-icon w-5 h-5 text-yellow-600 mt-0.5" id="warning-icon"></span>
                        <div class="flex-1">
                            <p class="font-medium text-yellow-800 mb-1">ุชุญุฐูุฑุงุช ุงูุชุฏุงุฎู:</p>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                ${overlaps.map(w => `<li>โข ${w.message}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
                container.innerHTML = html;
                lucide.createIcons({ icons: { AlertTriangle: document.getElementById('warning-icon') } });
            } else {
                container.classList.add('hidden');
            }
        }

        // ====================================================================
        // 3. ุฏูุงู ุงููุนุงูุฌุฉ (Handlers)
        // ====================================================================

        function handleAddProject() {
            const name = document.getElementById('name').value.trim();
            const lat = document.getElementById('lat').value;
            const lon = document.getElementById('lon').value;
            const radius = parseInt(document.getElementById('radius').value);

            if (!name || !lat || !lon) {
                showToast('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุงููุดุฑูุน ูุงูุฅุญุฏุงุซูุงุช.', 3000);
                return;
            }

            const newLat = parseFloat(lat);
            const newLon = parseFloat(lon);

            if (isNaN(newLat) || isNaN(newLon)) {
                showToast('ุงูุฅุญุฏุงุซูุงุช ุบูุฑ ุตุงูุญุฉ. ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฃุฑูุงู ููุท.', 3000);
                return;
            }

            const overlaps = checkOverlap(newLat, newLon, radius);

            const finalAddAction = () => {
                hideConfirmationModal(); // ูุฌุจ ุฅุฎูุงุก ุงููุงูุฐุฉ ูุจู ุฅุถุงูุฉ ุงููุดุฑูุน
                state.projects.push({ name, lat: newLat, lon: newLon, radius });
                
                // ุฅุนุงุฏุฉ ุชุนููู ุงูุญููู
                document.getElementById('name').value = '';
                document.getElementById('lat').value = '';
                document.getElementById('lon').value = '';
                document.getElementById('radius').value = 500;
                document.getElementById('radius-display').textContent = 500;
                state.selectedLocation = null;

                renderProjects();
                renderMap();
                updateWarnings();
                showToast(`โ ุชู ุฅุถุงูุฉ ุงููุดุฑูุน "${name}" ุจูุฌุงุญ!`, 3000);
            };

            if (overlaps.length > 0) {
                const message = `
                    <p class="mb-3">ููุงู ุชุฏุงุฎูุงุช ูุญุชููุฉ ูุน ุงููุดุงุฑูุน ุงูุชุงููุฉ:</p>
                    <ul class="text-sm text-right space-y-1">
                        ${overlaps.map(o => `<li>โข ${o.message}</li>`).join('')}
                    </ul>
                    <p class="mt-3 font-bold text-red-600">ูู ุชุฑูุฏ ุงููุชุงุจุนุฉ ูุฅุถุงูุฉ ุงููุดุฑูุน ุฑุบู ุงูุชุญุฐูุฑุงุชุ</p>
                `;
                showConfirmationModal('ุชุญุฐูุฑ ุชุฏุงุฎู', message, finalAddAction);
            } else {
                finalAddAction();
            }
        }

        function copyToClipboard(project, index) {
            // ุงุณุชุฎุฏุงู Tab (\t) ูููุตู ุจูู ุงูุฎูุงูุง ูุณูููุฉ ุงููุตู ูู ุฌุฏุงูู ุงูุจูุงูุงุช
            const text = `${project.name}\t${project.lat}\t${project.lon}\t${project.radius}`;
            
            navigator.clipboard.writeText(text).then(() => {
                state.copiedIndex = index;
                renderProjects(); // ุชุญุฏูุซ ุงูุตู ููุธูุฑ ุฑุณุงูุฉ "ุชู ุงููุณุฎ"
                setTimeout(() => {
                    state.copiedIndex = null;
                    renderProjects(); // ุฅุนุงุฏุฉ ุงูุชุญุฏูุซ ูุฅุฒุงูุฉ ุฑุณุงูุฉ "ุชู ุงููุณุฎ"
                }, 2000);
            }).catch(err => {
                console.error('ูุดู ุงููุณุฎ:', err);
                showToast('โ ูุดู ุงููุณุฎ ุฅูู ุงูุญุงูุธุฉ.', 3000);
            });
        }

        function copyAllProjects() {
            const text = state.projects.map(p => `${p.name}\t${p.lat}\t${p.lon}\t${p.radius}`).join('\n');
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('โ ุชู ูุณุฎ ุฌููุน ุงููุดุงุฑูุน ุฅูู ุงูุญุงูุธุฉ! ุงูุตู ูู Google Sheets ุงูุขู.', 4000);
            }).catch(err => {
                console.error('ูุดู ุงููุณุฎ:', err);
                showToast('โ ูุดู ุงููุณุฎ ุฅูู ุงูุญุงูุธุฉ.', 3000);
            });
        }

        function handleMapClick(e) {
            const mapElement = e.currentTarget;
            const rect = mapElement.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // ุชุญููู ุฅูู ุฅุญุฏุงุซูุงุช ุชูุฑูุจูุฉ ูููุทูุฉ ุงูุฑูุงุถ (ูุทุงู ุงูุฎุฑูุทุฉ)
            // ุงูุงูุชุฑุงุถ: ุฎุท ุงูุนุฑุถ: 24.7 (ุฃุณูู) ุฅูู 25.0 (ุฃุนูู)
            // ุงูุงูุชุฑุงุถ: ุฎุท ุงูุทูู: 46.5 (ูุณุงุฑ/ูููู) ุฅูู 46.8 (ูููู/ูุณุงุฑ)
            const mapLatMin = 24.7;
            const mapLatMax = 25.0;
            const mapLonMin = 46.5;
            const mapLonMax = 46.8;

            const latRange = mapLatMax - mapLatMin;
            const lonRange = mapLonMax - mapLonMin;

            // ุญุณุงุจ ุงูุฅุญุฏุงุซูุงุช ุจูุงุกู ุนูู ูููุน ุงูููุฑ
            // y: ูู ุงูุฃุนูู (0) ุฅูู ุงูุฃุณูู (rect.height)ุ Lat: ูู ุงูุฃุนูู (Max) ุฅูู ุงูุฃุณูู (Min)
            const lat = mapLatMin + (1 - (y / rect.height)) * latRange;
            // x: ูู ุงููููู (0) ุฅูู ุงููุณุงุฑ (rect.width)ุ Lon: ูู ุงููููู (Max) ุฅูู ุงููุณุงุฑ (Min)
            const lon = mapLonMin + (1 - (x / rect.width)) * lonRange;
            
            // ุจุณุจุจ ุงูุงุชุฌุงู ูู ุงููููู ุฅูู ุงููุณุงุฑ (RTL)ุ ูุฌุจ ุชุนุฏูู ุญุณุงุจ ุฎุท ุงูุทูู
            const lonRTL = mapLonMin + (x / rect.width) * lonRange;

            state.selectedLocation = { lat: lat.toFixed(7), lon: lonRTL.toFixed(7) };
            
            // ุชุญุฏูุซ ุญููู ุงูุฅุฏุฎุงู
            document.getElementById('lat').value = state.selectedLocation.lat;
            document.getElementById('lon').value = state.selectedLocation.lon;

            renderMap();
            updateWarnings(); // ุชุญุฏูุซ ุงูุชุญุฐูุฑุงุช ููุฑูุง
            showToast(`๐ ุชู ุชุญุฏูุฏ ุงููููุน ุนูู ุงูุฎุฑูุทุฉ: ${state.selectedLocation.lat}, ${state.selectedLocation.lon}`, 2500);
        }

        function handleImportFromUrl() {
            const url = prompt('ุงูุตู ุฑุงุจุท Google Maps ููุง:\n\nูุซุงู: https://www.google.com/maps/place/...');
            if (!url) return;

            let lat = null, lon = null;
            
            try {
                // ุงูุทุฑููุฉ 1: !3d ู !4d (ุงูุฃูุซุฑ ุฏูุฉ)
                let match = url.match(/!3d([-\d.]+)!4d([-\d.]+)/);
                if (match) {
                    lat = match[1];
                    lon = match[2];
                }

                // ุงูุทุฑููุฉ 2: @ ููุฑูุงุจุท ุงููุฎุชุตุฑุฉ
                if (!lat || !lon) {
                    match = url.match(/@([-\d.]+),([-\d.]+)/);
                    if (match) {
                        lat = match[1];
                        lon = match[2];
                    }
                }
                
                // ุงูุทุฑููุฉ 3: ุจุญุซ ุนู ุฃู ุฃุฑูุงู ุจุตูุบุฉ ุงูุฅุญุฏุงุซูุงุช (ูุฅุฌุฑุงุก ุฃุฎูุฑ)
                if (!lat || !lon) {
                    // ุงูุจุญุซ ุนู ููุท ุฅุญุฏุงุซูุงุช ุณุนูุฏูุฉ ุชูุฑูุจูุฉ (20-30 ูุฎุทูุท ุงูุนุฑุถุ 40-55 ูุฎุทูุท ุงูุทูู)
                    match = url.match(/([2]\d\.\d+).*([45]\d\.\d+)/);
                    if (match) {
                        lat = match[1];
                        lon = match[2];
                    }
                }

                if (lat && lon) {
                    const latNum = parseFloat(lat);
                    const lonNum = parseFloat(lon);
                    
                    // ุชุญูู ุจุณูุท ููุทุงู ุงูุฑูุงุถ (ูุชุฌูุจ ุงูุฅุญุฏุงุซูุงุช ุงูุฎุงุทุฆุฉ ุชูุงูุงู)
                    const isRiyadhRegion = (latNum >= 24.0 && latNum <= 25.5 && lonNum >= 46.0 && lonNum <= 47.5);
                    
                    document.getElementById('lat').value = latNum.toFixed(7);
                    document.getElementById('lon').value = lonNum.toFixed(7);
                    state.selectedLocation = { lat: latNum.toFixed(7), lon: lonNum.toFixed(7) };
                    renderMap();
                    updateWarnings();

                    if (isRiyadhRegion) {
                        showToast(`โ ุชู ุงุณุชุฎุฑุงุฌ ุงูุฅุญุฏุงุซูุงุช ุจูุฌุงุญ!`, 4000);
                    } else {
                        showToast(`โ๏ธ ุชุญุฐูุฑ: ุงูุฅุญุฏุงุซูุงุช ุฎุงุฑุฌ ูุทุงู ุงูุฑูุงุถ ุงูููุชุฑุถ! ููู ุชู ุชุนุจุฆุชูุง.`, 5000);
                    }
                } else {
                    showToast('โ ูู ุฃุชููู ูู ุงุณุชุฎุฑุงุฌ ุงูุฅุญุฏุงุซูุงุช ูู ุงูุฑุงุจุท. ุงูุฑุฌุงุก ุงูุชุฃูุฏ ูู ุฃู ุงูุฑุงุจุท ุตุญูุญ.', 5000);
                }
            } catch (error) {
                console.error('ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุฑุงุจุท:', error);
                showToast('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุงูุฑุงุจุท.', 4000);
            }
        }


        // ====================================================================
        // 4. ุฏูุงู ุงูุนุฑุถ (Rendering)
        // ====================================================================

        function renderMap() {
            const mapContainer = document.getElementById('map-simulation');
            
            // ุงููุทุงู ุงูุชูุฑูุจู ุงููุณุชุฎุฏู ููุนุฑุถ
            const mapLatMin = 24.7;
            const mapLatMax = 25.0;
            const mapLonMin = 46.5;
            const mapLonMax = 46.8;
            const latRange = mapLatMax - mapLatMin;
            const lonRange = mapLonMax - mapLonMin;

            // ุฅุฒุงูุฉ ุฌููุน ุงูููุงุท ุงููุฏููุฉ
            const existingPoints = mapContainer.querySelectorAll('.map-point');
            existingPoints.forEach(point => point.remove());

            // ุฏุงูุฉ ูุญุณุงุจ ุงููููุน ุจุงููุณุจุฉ ุงููุฆููุฉ
            const getPos = (lat, lon) => {
                const x = ((lon - mapLonMin) / lonRange) * 100;
                // ูุฌุจ ุนูุณ ูููุฉ Y ูุฃู 0% ุชููู ูู ุงูุฃุนูู (Latitude Max)
                const y = (1 - ((lat - mapLatMin) / latRange)) * 100;
                return { x, y };
            };

            // 1. ุนุฑุถ ุงููุดุงุฑูุน ุงูุญุงููุฉ
            state.projects.forEach(project => {
                const pos = getPos(project.lat, project.lon);
                
                // ุฅูุดุงุก ููุทุฉ ุงููุดุฑูุน
                const projectPin = document.createElement('div');
                projectPin.className = 'map-point absolute w-3 h-3 bg-red-500 rounded-full transform -translate-x-1/2 -translate-y-1/2 shadow-lg z-20 transition duration-150 hover:scale-[1.5] cursor-pointer';
                projectPin.style.left = `${pos.x}%`;
                projectPin.style.top = `${pos.y}%`;
                projectPin.title = project.name;
                
                // ุฅุถุงูุฉ ุงุณู ุงููุดุฑูุน ูุชุณููุฉ
                const label = document.createElement('div');
                label.className = 'absolute top-4 left-0 bg-white px-2 py-1 rounded shadow text-xs whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none';
                label.textContent = project.name;
                projectPin.appendChild(label);

                // ุฅุถุงูุฉ ุฏุงุฆุฑุฉ ุงููุทุงู (ุจุดูู ุชูุฑูุจู)
                const radiusCircle = document.createElement('div');
                // ูุทุงู (0.3) ูุนุงุฏู ุญูุงูู 33,000 ูุชุฑ. 
                // ูุชุญููู ูุตู ุงููุทุฑ (ูุชุฑ) ุฅูู ูุณุจุฉ ูุฆููุฉ ูู ูุทุงู ุงูุฎุฑูุทุฉ: 
                // (radius / 33000) * 100
                const radiusMapApprox = project.radius / 33000 * 100;
                
                radiusCircle.className = 'absolute inset-0 rounded-full border border-red-400 bg-red-400 bg-opacity-20 pointer-events-none';
                radiusCircle.style.width = `${radiusMapApprox * 2}%`; // ุงููุทุฑ
                radiusCircle.style.height = `${radiusMapApprox * 2}%`; // ุงููุทุฑ
                radiusCircle.style.transform = 'translate(-50%, -50%)';
                radiusCircle.style.left = '50%';
                radiusCircle.style.top = '50%';
                projectPin.appendChild(radiusCircle);

                mapContainer.appendChild(projectPin);
            });

            // 2. ุนุฑุถ ุงููููุน ุงููุญุฏุฏ ุญุฏูุซุงู
            if (state.selectedLocation) {
                const pos = getPos(parseFloat(state.selectedLocation.lat), parseFloat(state.selectedLocation.lon));
                
                let selectedPin = document.getElementById('selected-pin');
                if (!selectedPin) {
                    selectedPin = document.createElement('div');
                    selectedPin.id = 'selected-pin';
                    selectedPin.className = 'map-point absolute w-4 h-4 bg-blue-500 rounded-full transform -translate-x-1/2 -translate-y-1/2 shadow-lg animate-pulse z-30';
                    mapContainer.appendChild(selectedPin);
                }
                selectedPin.style.left = `${pos.x}%`;
                selectedPin.style.top = `${pos.y}%`;
            } else {
                const selectedPin = document.getElementById('selected-pin');
                if (selectedPin) selectedPin.remove();
            }
        }

        function renderProjects() {
            const tbody = document.getElementById('projects-table-body');
            const filteredProjects = state.projects.filter(p => 
                p.name.toLowerCase().includes(state.searchQuery.toLowerCase())
            );
            
            document.getElementById('projects-count').textContent = state.projects.length;

            if (filteredProjects.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            ูุง ุชูุฌุฏ ูุดุงุฑูุน ูุถุงูุฉ ุฃู ูุง ุชูุฌุฏ ูุชุงุฆุฌ ููุจุญุซ.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredProjects.map((project, index) => {
                // ุงูุนุซูุฑ ุนูู ุงูููุฑุณ ุงูุฃุตูู ูููุดุฑูุน ูุจู ุงูุชุตููุฉ
                const originalIndex = state.projects.findIndex(p => p.name === project.name && p.lat === project.lat);
                
                const isCopied = state.copiedIndex === originalIndex;
                const copyButtonHtml = `
                    <button
                        onclick="copyToClipboard(state.projects[${originalIndex}], ${originalIndex})"
                        class="flex items-center gap-2 px-3 py-1.5 ${isCopied ? 'bg-green-100 text-green-700' : 'bg-indigo-100 text-indigo-700'} rounded-lg hover:bg-indigo-200 transition text-sm"
                    >
                        ${isCopied ? 
                            `<span class="lucide-icon w-4 h-4">${lucide.icons.Check.toSvg()}</span> ุชู ุงููุณุฎ` :
                            `<span class="lucide-icon w-4 h-4">${lucide.icons.Copy.toSvg()}</span> ูุณุฎ`
                        }
                    </button>
                `;

                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50 transition">
                        <td class="px-4 py-3 text-gray-800 font-medium">${project.name}</td>
                        <td class="px-4 py-3 text-gray-600 font-mono text-sm">${project.lat.toFixed(7)}</td>
                        <td class="px-4 py-3 text-gray-600 font-mono text-sm">${project.lon.toFixed(7)}</td>
                        <td class="px-4 py-3 text-gray-600">${project.radius}</td>
                        <td class="px-4 py-3">${copyButtonHtml}</td>
                    </tr>
                `;
            }).join('');
        }

        // ====================================================================
        // 5. ุงูุชููุฆุฉ (Initialization)
        // ====================================================================

        window.onload = function() {
            renderIcons();

            // 5.1 ุงูุจูุงูุงุช ุงูุฃูููุฉ
            state.projects = [
                { name: 'ุงููุณูุน', lat: 24.8701046, lon: 46.6085953, radius: 1000 },
                { name: 'ุฑุตู 21', lat: 24.8725393, lon: 46.6534205, radius: 1000 },
                { name: 'ุฑุณูู 15', lat: 24.7844330, lon: 46.6245780, radius: 200 }
            ];

            // 5.2 ุฑุจุท ุงูุฃุญุฏุงุซ
            
            // ุฅุถุงูุฉ ูุดุฑูุน ุฌุฏูุฏ
            document.getElementById('new-project-form').addEventListener('submit', (e) => {
                e.preventDefault();
                handleAddProject();
            });

            // ุชุญุฏูุซ ูููุฉ ูุทุงู ุงูุญุถูุฑ
            document.getElementById('radius').addEventListener('input', (e) => {
                document.getElementById('radius-display').textContent = e.target.value;
                updateWarnings();
            });
            
            // ุชุญุฏูุซ ุงูุชุญุฐูุฑุงุช ุนูุฏ ุชุบููุฑ ุฎุทูุท ุงูุนุฑุถ/ุงูุทูู ูุฏููุงู
            document.getElementById('lat').addEventListener('input', updateWarnings);
            document.getElementById('lon').addEventListener('input', updateWarnings);

            // ุฒุฑ ุงุณุชูุฑุงุฏ ูู ุฑุงุจุท
            document.getElementById('import-url-btn').addEventListener('click', handleImportFromUrl);

            // ุฒุฑ ูุณุฎ ุงููู
            document.getElementById('copy-all-btn').addEventListener('click', copyAllProjects);

            // ุงูููุฑ ุนูู ุงูุฎุฑูุทุฉ
            document.getElementById('map-simulation').addEventListener('click', handleMapClick);

            // ุญูู ุงูุจุญุซ
            document.getElementById('search-query').addEventListener('input', (e) => {
                state.searchQuery = e.target.value;
                renderProjects();
            });

            // ุฃุฒุฑุงุฑ ูุงูุฐุฉ ุงูุชุฃููุฏ
            document.getElementById('modal-cancel-btn').addEventListener('click', hideConfirmationModal);
            document.getElementById('modal-confirm-btn').addEventListener('click', () => {
                if (state.modal.confirmAction) {
                    state.modal.confirmAction();
                }
            });

            // 5.3 ุงูุนุฑุถ ุงูุฃููู
            renderProjects();
            renderMap();
            updateWarnings();
        };
    </script>
</body>
</html>
